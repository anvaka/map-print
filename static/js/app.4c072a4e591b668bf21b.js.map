{"version":3,"sources":["webpack:///./src/bus.js","webpack:///./src/appState.js","webpack:///./src/lib/postData.js","webpack:///./src/lib/query-presets.js","webpack:///./src/lib/bbox.js","webpack:///./src/lib/createProjector.js","webpack:///./src/lib/constructGraph.js","webpack:///./src/lib/formatNumber.js","webpack:///./src/main.js","webpack:///./src/lib/osm.js","webpack:///./src/lib/request.js"],"names":["bus","__webpack_require__","__webpack_exports__","graph","graphBounds","projector","appState","currentState","selected","aboutVisible","blank","error","kmlLayers","currentScript","showZoomWarning","possibleScripts","options","value","text","downloadOsmProgress","building","buildingMessage","zazzleLink","showCancelDownload","getGraphBBox","getGraph","setGraph","newGraph","bounds","newProjector","startOver","generatingPreview","backgroundColor","r","g","b","a","lineColor","getProjector","addKMLLayer","name","layer","push","viewModel","color","width","updateColor","getKMLLayer","makeKMLLayerViewModel","removeKMLLayer","layerModel","layerIndex","indexOf","Error","splice","overpassUrl","backupUrl","postData","data","progress","useBackup","Object","request","method","responseType","headers","Content-type","body","encodeURIComponent","catch","err","metaTags","highwayTags","join","query_presets","roads","bbox","waterway","buildings","rivers","BBox","classCallCheck_default","this","minX","Number","POSITIVE_INFINITY","minY","maxX","NEGATIVE_INFINITY","maxY","offset","xIn","yIn","undefined","x","y","rect","addPoint","left","top","right","bottom","otherBBox","d3geo","createGraph","asyncFor","constructGraph","osmResponse","filter","elements","lonLatBoundingBox","promise_default","resolve","addToBoundingBox","element","elementIdx","type","lon","lat","length","computeBoundingBox","then","lonLatBbox","q","geoMercator","center","cx","cy","scale","xyPoint","createProjector","visit","nodeData","addNode","id","nodes","forEach","node","idx","from","to","getNode","addLink","formatNumber","is_finite_default","toString","replace","MapboxGeocoder","e","bind","oe","cancelDownload","main_map","map","updateZoomWarning","getZoom","downloadRoads","getBounds","sw","getSouthWest","ne","getNorthEast","boundingBox","lng","downloadPromise","cancel","el","makeFilterInsideBoundingBox","updateConstructionProgress","_ref","getLinksCount","fire","cancelled","renderAfterResolution","scriptKind","getRoadsInBoundingBox","updateDownloadProgress","p","loaded","lengthComputable","total","percent","current","kind","totalStr","currentStr","init","mapbox_gl_default","accessToken","Map","container","style","zoom","hash","addControl","NavigationControl","showCompass","on","dragRotate","disable","touchZoomRotate","disableRotation","url","req","cancelable","__WEBPACK_IMPORTED_MODULE_1_babel_runtime_core_js_promise___default","reject","XMLHttpRequest","addEventListener","status","response","JSON","parse","message","open","__WEBPACK_IMPORTED_MODULE_0_babel_runtime_core_js_object_keys___default","key","setRequestHeader","send","abort"],"mappings":"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","file":"static/js/app.4c072a4e591b668bf21b.js","sourcesContent":["var bus = require('ngraph.events')({});\n\nexport default bus;\n\n\n// WEBPACK FOOTER //\n// ./src/bus.js","// const ratio = 540/230 - mug\nconst appState = {\n  currentState: 'intro',\n  selected: null,\n  aboutVisible: false,\n  blank: false,\n  error: null,\n  kmlLayers: [],\n  currentScript: 'roads',\n  showZoomWarning: false,\n  possibleScripts: {\n    selected: 'roads',\n    options: [{\n      value: 'roads',\n      text: 'Roads'\n    }, {\n      value: 'buildings',\n      text: 'Buildings'\n    }, {\n      value: 'rivers',\n      text: 'Rivers'\n    }]\n  },\n  downloadOsmProgress: null,\n  building: false,\n  buildingMessage: '',\n  zazzleLink: null,\n  showCancelDownload: false,\n  getGraphBBox,\n  getGraph,\n  setGraph,\n  startOver,\n  generatingPreview: false,\n\n  backgroundColor: {\n    r: 255, g: 255, b: 255, a: 1\n  },\n  lineColor: {\n    r: 22, g: 22, b: 22, a: 0.85\n  },\n\n  getProjector,\n\n  addKMLLayer,\n  removeKMLLayer\n};\n\nvar graph;\nvar graphBounds;\n// projects lon/lat into current XY plane\nvar projector;\n\nfunction getGraphBBox() {\n  return graphBounds;\n}\n\nfunction getGraph() {\n  return graph;\n}\n\nfunction setGraph(newGraph, bounds, newProjector) {\n  graph = newGraph;\n  graphBounds = bounds;\n  projector = newProjector;\n}\n\nfunction getProjector() {\n  return projector;\n}\n\nfunction startOver() {\n  appState.zazzleLink = null;\n  appState.generatingPreview = false;\n  appState.currentState = 'intro';\n  appState.blank = false,\n  appState.downloadOsmProgress = null;\n  appState.kmlLayers = [];\n}\n\n\nfunction addKMLLayer(name, layer) {\n  appState.kmlLayers.push(makeKMLLayerViewModel(name, layer));\n}\n\nfunction removeKMLLayer(layerModel) {\n  let layerIndex = appState.kmlLayers.indexOf(layerModel);\n  if (layerIndex < 0) {\n    throw new Error('Invalid layer to remove');\n  }\n  appState.kmlLayers.splice(layerIndex, 1);\n}\n\nexport default appState;\n\nfunction makeKMLLayerViewModel(name, layer) {\n  const viewModel = {\n    name,\n    color: layer.color,\n    width: layer.width,\n    updateColor() {\n      layer.updateColor(viewModel.color);\n    },\n\n    getKMLLayer() { return layer }\n  }\n\n  return viewModel;\n}\n\n\n// WEBPACK FOOTER //\n// ./src/appState.js","import request from './request';\n\nconst overpassUrl = 'https://overpass-api.de/api/interpreter' ;\nconst backupUrl = 'https://overpass.kumi.systems/api/interpreter';\n\nexport default function postData(data, progress, useBackup) {\n  return request(useBackup ? backupUrl : overpassUrl, {\n    method: 'POST',\n    responseType: 'json',\n    progress,\n    headers: {\n      'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'\n    },\n    body: 'data=' + encodeURIComponent(data),\n  }, 'POST').catch(err => {\n    if (useBackup) {\n      // we can't do much anymore\n      throw err;\n    }\n\n    return postData(data, progress, /* useBackup = */ true);\n  });\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/postData.js","const metaTags = '[timeout:9000][maxsize:2000000000][out:json];';\n\nconst highwayTags = [\n  'motorway',\n  'motorway_link',\n  'trunk',\n  'trunk_link',\n  'primary',\n  'primary_link',\n  'secondary',\n  'secondary_link',\n  'tertiary',\n  'tertiary_link',\n  'unclassified',\n  'unclassified_link',\n  'residential',\n  'residential_link',\n  'service',\n  'service_link',\n  'living_street',\n  'pedestrian',\n  'road'\n].join('|');\n\n\nexport default {\n  roads(bbox) {\n    return `${metaTags}\n(\n  way[\"highway\"~\"${highwayTags}\"](${bbox});\n  node(w);\n);\nout skel;`\n  },\n  waterway(bbox) {\n    return `${metaTags}\n(\n  way[\"waterway\"](${bbox});\n  node(w);\n);\nout skel;`\n  },\n  buildings(bbox) {\n    return `${metaTags}\n(\n  way[\"building\"](${bbox});\n  node(w);\n);\nout skel;`\n  },\n  rivers(bbox) {\n    return `${metaTags}\n(\n  way[\"waterway\"=\"river\"](${bbox});\n  node(w);\n);\nout skel;`\n  },\n}\n\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/query-presets.js","export default class BBox {\n  constructor() {\n    this.minX = Number.POSITIVE_INFINITY;\n    this.minY = Number.POSITIVE_INFINITY;\n    this.maxX = Number.NEGATIVE_INFINITY;\n    this.maxY = Number.NEGATIVE_INFINITY;\n  }\n\n  growBy(offset) {\n    this.minX -= offset;\n    this.minY -= offset;\n    this.maxX += offset;\n    this.maxY += offset;\n  }\n\n  get left() {\n    return this.minX;\n  }\n\n  get top() {\n    return this.minY;\n  }\n\n  get right() {\n    return this.maxX;\n  }\n\n  get bottom() {\n    return this.maxY;\n  }\n\n  get width() {\n    return this.maxX - this.minX;\n  }\n\n  get height() {\n    return this.maxY - this.minY;\n  }\n\n  get cx() {\n    return (this.minX + this.maxX)/2;\n  }\n\n  get cy() {\n    return (this.minY + this.maxY)/2;\n  }\n\n  addPoint(xIn, yIn) {\n    if (xIn === undefined) throw new Error('Point is not defined');\n    let x = xIn;\n    let y = yIn;\n    if (y === undefined) {\n      // xIn is a point object\n      x = xIn.x;\n      y = xIn.y;\n    }\n\n    if (x < this.minX) this.minX = x;\n    if (x > this.maxX) this.maxX = x;\n    if (y < this.minY) this.minY = y;\n    if (y > this.maxY) this.maxY = y;\n  }\n\n  addRect(rect) {\n    if (!rect) throw new Error('rect is not defined');\n    this.addPoint(rect.left, rect.top);\n    this.addPoint(rect.right, rect.top);\n    this.addPoint(rect.left, rect.bottom);\n    this.addPoint(rect.right, rect.bottom);\n  }\n\n  merge(otherBBox) {\n    if (otherBBox.minX < this.minX) this.minX = otherBBox.minX;\n    if (otherBBox.minY < this.minY) this.minY = otherBBox.minY;\n    if (otherBBox.maxX > this.maxX) this.maxX = otherBBox.maxX;\n    if (otherBBox.maxY > this.maxY) this.maxY = otherBBox.maxY;\n  }\n}\n\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/bbox.js","var d3geo = require('d3-geo')\n\nexport default function createProjector(lonLatBbox, r) {\n  if (!r) r = 6371393; // radius of earth in meters\n\n  var q = [0, 0];\n  var projector = d3geo.geoMercator()\n      .center([lonLatBbox.cx, lonLatBbox.cy])\n      .scale(r)\n\n  return function(lon, lat) {\n    q[0] = lon; q[1] = lat;\n\n    let xyPoint = projector(q)\n\n    return {\n      x: xyPoint[0],\n      y: xyPoint[1]\n    };\n  };\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/createProjector.js","import BBox from './bbox';\nimport createProjector from './createProjector';\nvar createGraph = require('ngraph.graph');\nvar asyncFor = require('rafor');\n\nexport default function constructGraph(osmResponse, filter, progress) {\n  var {elements} = osmResponse;\n\n  return computeBoundingBox().then(constructGraphAndBounds);\n\n  function computeBoundingBox() {\n    var lonLatBoundingBox = new BBox();\n\n    return new Promise(resolve => {\n      asyncFor(elements, addToBoundingBox, () => {\n          resolve(lonLatBoundingBox);\n        }\n      );\n    });\n\n    function addToBoundingBox(element, elementIdx) {\n      if (element.type === 'node') {\n        lonLatBoundingBox.addPoint(element.lon, element.lat);\n      }\n      if ((elementIdx % 50000) === 0) {\n        progress(elementIdx, elements.length, 'bounds');\n      }\n    }\n  }\n\n  function constructGraphAndBounds(lonLatBoundingBox) {\n    var projector = createProjector(lonLatBoundingBox);\n    var graph = createGraph();\n    var offset = new BBox();\n\n    return new Promise(resolve => {\n      asyncFor(elements, visit, () => resolve({\n        graph, \n        projector,\n        bounds: offset\n      }));\n    })\n\n    function visit(element, elementIdx) {\n      if (element.type === 'node') {\n        if (filter && !filter(element)) {\n          return;\n        }\n        var nodeData = projector(element.lon, element.lat);\n        offset.addPoint(nodeData.x, nodeData.y);\n        graph.addNode(element.id, nodeData)\n      } else if (element.type === 'way') {\n        element.nodes.forEach((node, idx) => {\n          if (idx > 0) {\n            const from = element.nodes[idx - 1];\n            const to = element.nodes[idx];\n            if (graph.getNode(from) && graph.getNode(to)) {\n              graph.addLink(from, to);\n            }\n          } \n        })\n      }\n\n      if ((elementIdx % 50000) === 0) {\n        progress(elementIdx, elements.length, 'graph');\n      }\n    }\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/constructGraph.js","export default function formatNumber(x) {\n  if (!Number.isFinite(x)) return 'N/A';\n  return x.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/lib/formatNumber.js","/**\n * This is the website startup point.\n */\nimport * as osm from './lib/osm';\nimport appState from './appState';\nimport bus from './bus';\nimport constructGraph from './lib/constructGraph';\nimport formatNumber from './lib/formatNumber';\nimport mapboxgl from 'mapbox-gl';\n\nvar MapboxGeocoder = require('@mapbox/mapbox-gl-geocoder');\n\n// Load vue asyncronously\nrequire.ensure('@/vueApp.js', () => {\n  require('@/vueApp.js');\n});\n\n// Hold a reference to mapboxgl instance.\nlet map;\n// This will hold a reference to a function which cancels current download\nvar cancelDownload;\n\n// Let the vue know what to call to start the app.\nappState.init = init;\n\nfunction init() {\n  // Please don't use this token. It is bound to my domain and wouldn't work\n  // when you deploy to your website.\n  mapboxgl.accessToken = 'pk.eyJ1IjoiYW52YWthIiwiYSI6ImNrNWRqcDdnNTF4MHYzbXAzNDJzODludnYifQ.2WDAbuAzUuchNtCAcZitAw';\n  map = new mapboxgl.Map({\n      container: 'map',\n      style: 'mapbox://styles/mapbox/streets-v9',\n      center: [-122.2381,47.624],\n      zoom: 11.32,\n      hash: true\n  });\n\n  map.addControl(new mapboxgl.NavigationControl({showCompass: false}), 'bottom-right');\n  map.addControl(new MapboxGeocoder({accessToken: mapboxgl.accessToken}));\n  map.on('zoom', updateZoomWarning);\n\n  map.dragRotate.disable();\n  map.touchZoomRotate.disableRotation();\n\n  // On large screens we want to warn people that they may end up downloading a lot of stuff\n  updateZoomWarning();\n\n  bus.on('download-all-roads', downloadRoads);\n  bus.on('cancel-download-all-roads', () => {\n    if (cancelDownload) cancelDownload();\n  });\n};\n\nfunction updateZoomWarning() {\n  appState.showZoomWarning = map.getZoom() < 9.7;\n}\n\nfunction downloadRoads() {\n  const bounds = map.getBounds();\n  const sw = bounds.getSouthWest();\n  const ne = bounds.getNorthEast()\n  const boundingBox = `${sw.lat},${sw.lng},${ne.lat},${ne.lng}`;\n\n  appState.building = true;\n  appState.buildingMessage = 'Sending query to OSM...'\n  appState.blank = false;\n  appState.error = null;\n\n  const scriptKind = appState.possibleScripts.selected;\n  const downloadPromise = osm.getRoadsInBoundingBox(scriptKind, boundingBox, updateDownloadProgress);\n\n  renderAfterResolution(downloadPromise);\n}\n\nfunction renderAfterResolution(downloadPromise) {\n  // Since promises do not support cancellation, we have to invent our own.\n  // when cancelDownload is set we can cancel the download...\n  cancelDownload = downloadPromise.cancel;\n  appState.showCancelDownload = true;\n\n  downloadPromise.then(osmResponse => {\n    cancelDownload = null;\n    appState.showCancelDownload = false;\n    return constructGraph(osmResponse, makeFilterInsideBoundingBox(), updateConstructionProgress);\n  }).then(({graph, bounds, projector}) => {\n    appState.setGraph(graph, bounds, projector);\n    appState.building = false;\n\n    if (graph.getLinksCount() === 0) {\n      appState.blank = true;\n    } else {\n      appState.currentState = 'canvas';\n      appState.blank = false;\n      bus.fire('graph-loaded');\n    }\n  }).catch(err => {\n    if (err && err.cancelled) {\n      cancelDownload = null;\n      appState.building = false;\n      appState.showCancelDownload = false;\n    } else {\n      appState.building = false;\n      appState.error = err;\n    }\n  });\n}\n\nfunction makeFilterInsideBoundingBox() {\n  // Some elements in the OSM response can be outside of the visible box\n  // ignore them.\n  const bounds = map.getBounds();\n  const sw = bounds.getSouthWest();\n  const ne = bounds.getNorthEast()\n\n  return filterRoadsOutOfBounds;\n\n  function filterRoadsOutOfBounds(el) {\n    return el.lon >= sw.lng && el.lon <= ne.lng &&\n            el.lat >= sw.lat && el.lat <= ne.lat;\n  }\n}\n\nfunction updateDownloadProgress(p) {\n  let loaded = formatNumber(p.loaded);\n\n  if (p.lengthComputable) {\n    let total = formatNumber(p.total);\n    appState.buildingMessage = `Downloading data: ${p.percent * 100}% (${loaded} of ${total} bytes)`;\n  } else {\n    appState.buildingMessage = `Downloading data: ${loaded} bytes so far...`;\n  }\n}\n\n\nfunction updateConstructionProgress(current, total, kind) {\n  let totalStr = formatNumber(total);\n  let currentStr = formatNumber(current);\n  if (kind === 'graph') {\n    appState.buildingMessage = `Making graph: ${currentStr} of ${totalStr} records`;\n  } else {\n    appState.buildingMessage = `Computing bounds: ${currentStr} of ${totalStr} records`;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/main.js","import postData from './postData';\n\nimport queryPresets from './query-presets';\n\nexport function getAreasAround(lonLat, bounds) {\n  var sw = bounds.getSouthWest();\n  var ne = bounds.getNorthEast()\n  return postData(\n    `[timeout:10][out:json];\nis_in(${lonLat.lat}, ${lonLat.lng})->.a;\nway(pivot.a);\nout tags bb;\nout ids geom(${sw.lat},${sw.lng},${ne.lat},${ne.lng});\nrelation(pivot.a);\nout tags bb;`\n  );\n}\n\nexport function getRelationBoundary(relId) {\n  return postData(`[timeout:10][out:json];\nrel(${relId});\n(\n  way(r);\n  node(w);\n);\nout skel;`).then(response => {\n  var nodes = new Map();\n  var ways = [];\n  response.elements.forEach(el => {\n    if (el.type === 'node') {\n      nodes.set(el.id, el);\n    } else if (el.type === 'way') {\n      ways.push(el);\n    }\n  });\n  return {\n    nodes, ways\n  }\n})\n}\n\nexport function getRoadsInBoundingBox(scriptKind, boundingBox, progress) {\n  return postData(queryPresets[scriptKind](boundingBox) , progress);\n}\n\nexport function getRoadsInRelationship(relId) {\n  return postData(\n  `[timeout:9000][maxsize:2000000000][out:json];\nrel(${relId});\nmap_to_area->.a;\n(\n way[\"waterway\"](area.a);\n node(w);\n);\nout skel;`);\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/osm.js","export default function request(url, options) {\n  if (!options) options = {};\n  let req;\n  let cancelable = new Promise(download);\n  cancelable.cancel = cancel;\n\n  return cancelable;\n\n  function cancel() {\n    if (req) {\n      req.abort();\n    }\n  }\n\n  function download(resolve, reject) {\n    req = new XMLHttpRequest();\n\n    if (typeof options.progress === 'function') {\n      req.addEventListener('progress', updateProgress, false);\n      // req.upload.addEventListener('progress', updateProgress, false);\n    }\n\n    req.addEventListener('load', transferComplete, false);\n    req.addEventListener('error', transferFailed, false);\n    req.addEventListener('abort', transferCanceled, false);\n\n    req.open(options.method || 'GET', url);\n    if (options.responseType) {\n      req.responseType = options.responseType;\n    }\n    if (options.headers) {\n      Object.keys(options.headers).forEach(key => {\n        req.setRequestHeader(key, options.headers[key]);\n      });\n    }\n\n    if (options.method === 'POST') {\n      req.send(options.body);\n    } else {\n      req.send(null);\n    }\n\n    function updateProgress(e) {\n      if (e.lengthComputable) {\n        options.progress({\n          loaded: e.loaded,\n          total: e.total,\n          percent: e.loaded / e.total,\n          lengthComputable: true\n        });\n      } else {\n        options.progress({\n          loaded: e.loaded,\n          lengthComputable: false\n        });\n      }\n    }\n\n    function transferComplete() {\n      if (req.status !== 200) {\n        reject(`Unexpected status code ${req.status} when calling ${url}`);\n        return;\n      }\n      var response = req.response;\n\n      if (options.responseType === 'json' && typeof response === 'string') {\n        // IE\n        response = JSON.parse(response);\n      }\n\n      resolve(response);\n    }\n\n    function transferFailed() {\n      reject(`Failed to download ${url}`);\n    }\n\n    function transferCanceled() {\n      reject({\n        cancelled: true,\n        message: `Cancelled download of ${url}`\n      });\n    }\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./src/lib/request.js"],"sourceRoot":""}